
VERSION=@VERSION@

do_substitution = date=$$(date);sed -e "s,[@]DATE[@],$${date},g" \
	-e "s,[@]VERSION[@],@VERSION@,g"

rpm:
	make dist
	mkdir -p RPM/SOURCES
	cp cyberprobe-${VERSION}.tar.gz RPM/SOURCES/
	rpmbuild --define "_topdir `pwd`/RPM" -ba cyberprobe.spec

debian/changelog: $(srcdir)/debian/changelog.in Makefile
	$(do_substitution) < $(srcdir)/debian/changelog.in > debian/changelog

deb: debian/changelog
	rm -rf cyberprobe-${VERSION}
	make dist
	cp cyberprobe-${VERSION}.tar.gz cyberprobe_${VERSION}.orig.tar.gz
	tar xfz cyberprobe-${VERSION}.tar.gz
	cp -r debian/ cyberprobe-${VERSION}/
	cd cyberprobe-${VERSION}/; dpkg-buildpackage -us -uc

# Hack, Ubuntu libreadline version is different.
ubuntu: debian/changelog
	rm -rf cyberprobe-${VERSION}
	make dist
	cp cyberprobe-${VERSION}.tar.gz cyberprobe_${VERSION}.orig.tar.gz
	tar xfz cyberprobe-${VERSION}.tar.gz
	cp -r debian/ cyberprobe-${VERSION}/
	sed -i 's/libreadline6/libreadline7/g' cyberprobe-${VERSION}/debian/control
	cd cyberprobe-${VERSION}/; dpkg-buildpackage -us -uc

tag:
	git tag -a v${VERSION} -m ''
	git push --tags

create-release:
	body='{"tag_name": "v'${VERSION}'", "name": "v'${VERSION}'", "body": "Release '${VERSION}'", "draft": false, "prerelease": false}'; \
	token=$$(cat TOKEN); \
	curl --data "$$body"" "https://api.github.com/repos/cybermaggedon/cyberprobe/releases?access_token=$$token"

